<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Your Trip - Planora</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/planning.css">
</head>

<body>
   <nav id="mainNav">
    <div class="logo">
        <img src="../Svg/Logo.png" alt="Planora">
    </div>
    <div class="nav-center">
        <a href="../index.html">Home</a>
        <a href="./trips.html">My Trips</a>
        <div class="search-bar">
            <input type="search" id="searchInput" placeholder="Search destinations...">
            <i class="fa fa-search search-icon"></i>
        </div>
    </div>
    <div class="auth-buttons">
        <button class="primary" onclick="window.location.href='./login.html'">Login</button>
        <button class="secondary" onclick="window.location.href='./signup.html'">Sign Up</button>
    </div>
</nav>

    <div class="planning-container">
        <!-- Progress Steps -->
        <div class="progress-steps">
            <div class="step active">
                <div class="step-circle">1</div>
                <span>Basic Details</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">2</div>
                <span>Dates & Budget</span>
            </div>
            <div class="step-line"></div>
            <div class="step">
                <div class="step-circle">3</div>
                <span>Preferences</span>
            </div>
        </div>

        <div class="page-header">
            <h1>Create Your Perfect Trip</h1>
            <p>Fill in the details below to start planning your adventure</p>
        </div>

        <div class="content-wrapper">
            <div class="form-section">
                <form id="createTripForm">
                    <!-- Step 1: Basic Details -->
                    <div class="form-step active" id="step1">
                        <h2 class="step-title">
                            <i class="fas fa-info-circle"></i>
                            Basic Information
                        </h2>

                        <div class="form-group">
                            <label for="title">
                                <i class="fas fa-heading"></i>
                                Trip Title *
                            </label>
                            <input type="text" id="title" name="title" placeholder="e.g., Summer Vacation in Europe"
                                required minlength="3" maxlength="100">
                            <small class="field-hint">Give your trip a memorable name</small>
                        </div>

                        <div class="form-group">
                            <label for="destination">
                                <i class="fas fa-map-marker-alt"></i>
                                Destination *
                            </label>
                            <input type="text" id="destination" name="destination" placeholder="e.g., Paris, France"
                                required minlength="2">
                            <small class="field-hint">Where are you planning to go?</small>
                        </div>

                        <div class="form-group">
                            <label for="travelers">
                                <i class="fas fa-users"></i>
                                Number of Travelers
                            </label>
                            <input type="number" id="travelers" name="travelers" min="1" max="50" placeholder="1"
                                value="1">
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="window.location.href='trips.html'">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="button" class="btn-primary" onclick="validateStep(1,2)">
                                Next Step <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Dates & Budget -->
                    <div class="form-step" id="step2">
                        <h2 class="step-title">
                            <i class="fas fa-calendar-alt"></i>
                            Dates & Budget
                        </h2>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">
                                    <i class="far fa-calendar"></i>
                                    Start Date *
                                </label>
                                <input type="date" id="startDate" name="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="endDate">
                                    <i class="far fa-calendar"></i>
                                    End Date *
                                </label>
                                <input type="date" id="endDate" name="endDate" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="budget">
                                <i class="fas fa-rupee-sign"></i>
                                Budget
                            </label>
                            <input type="number" id="budget" name="budget" placeholder="₹ Enter your budget" min="0"
                                step="100">
                            <small class="field-hint">Estimated budget for the entire trip</small>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(1)">
                                <i class="fas fa-arrow-left"></i>
                                Previous
                            </button>
                            <button type="button" class="btn-primary" onclick="validateStep(2, 3)">
                                Next Step <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Preferences -->
                    <div class="form-step" id="step3">
                        <h2 class="step-title">
                            <i class="fas fa-sliders-h"></i>
                            Trip Preferences
                        </h2>

                        <div class="form-group">
                            <label for="description">
                                <i class="fas fa-align-left"></i>
                                Description
                            </label>
                            <textarea id="description" name="description" rows="4"
                                placeholder="Describe your trip interests, must-see places, or any special requirements..."
                                maxlength="1000"></textarea>
                            <small class="field-hint">Help us personalize your experience</small>
                        </div>

                        <div class="form-group">
                            <label for="tags">
                                <i class="fas fa-tags"></i>
                                Tags (comma separated)
                            </label>
                            <input type="text" id="tags" name="tags"
                                placeholder="e.g., adventure, beach, culture, food">
                            <small class="field-hint">Add keywords to categorize your trip</small>
                        </div>

                        <div class="form-group checkbox-wrapper">
                            <label class="checkbox-label">
                                <input type="checkbox" id="isPublic" name="isPublic">
                                <span class="checkbox-text">
                                    <i class="fas fa-globe"></i>
                                    Make this trip public
                                </span>
                            </label>
                            <small class="field-hint">Share your itinerary with the community</small>
                        </div>

                        <div class="form-actions">
                            <button type="button" class="btn-secondary" onclick="prevStep(2)">
                                <i class="fas fa-arrow-left"></i>
                                Previous
                            </button>
                            <button type="submit" class="btn-primary" id="createTripBtn">
                                <i class="fas fa-check"></i>
                                Create Trip
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="preview-section">
                <div class="preview-card">
                    <h3>
                        <i class="fas fa-eye"></i>
                        Trip Preview
                    </h3>
                    <div class="preview-content">
                        <div class="preview-item">
                            <i class="fas fa-heading"></i>
                            <div>
                                <strong>Title</strong>
                                <p id="previewTitle">-</p>
                            </div>
                        </div>
                        <div class="preview-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <div>
                                <strong>Destination</strong>
                                <p id="previewDestination">-</p>
                            </div>
                        </div>
                        <div class="preview-item">
                            <i class="far fa-calendar"></i>
                            <div>
                                <strong>Duration</strong>
                                <p id="previewDuration">-</p>
                            </div>
                        </div>
                        <div class="preview-item">
                            <i class="fas fa-rupee-sign"></i>
                            <div>
                                <strong>Budget</strong>
                                <p id="previewBudget">-</p>
                            </div>
                        </div>
                        <div class="preview-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <strong>Travelers</strong>
                                <p id="previewTravelers">1</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="map-card">
                    <h3>
                        <i class="fas fa-map"></i>
                        Location
                    </h3>
                    <div id="map"></div>
                </div>

                <div class="tips-card">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        Planning Tips
                    </h3>
                    <ul>
                        <li><i class="fas fa-check"></i> Book flights 2-3 months in advance for better deals</li>
                        <li><i class="fas fa-check"></i> Research visa requirements early</li>
                        <li><i class="fas fa-check"></i> Create a flexible itinerary with buffer time</li>
                        <li><i class="fas fa-check"></i> Save copies of important documents</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>
    
<!-- ============================================
     CRITICAL: Load scripts in correct order
     ============================================ -->

<!-- 0. External libraries FIRST (Leaflet for maps) -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- 1. Config -->
<script src="../js/config.js"></script>

<!-- 2. API Service -->
<script src="../js/api-service.js?v=2"></script>

<!-- 3. Toast -->
<script src="../js/toast.js"></script>

<!-- 4. Auth -->
<script src="../js/auth.js"></script>

<!-- 5. Nav -->
<script src="../js/nav.js"></script>

<!-- 6. Page script (plan.js) -->
<script src="../js/plan.js"></script>

<!-- 7. Inline scripts for UI - MUST BE DEFINED BEFORE ONCLICK HANDLERS RUN -->
<script>
    let currentStep = 1;
    let tripMap = null; // Renamed to avoid conflicts

    function nextStep(step) {
        document.querySelectorAll('.form-step').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.step').forEach((s, i) => {
            s.classList.remove('active');
            if (i < step) s.classList.add('completed');
        });

        document.getElementById('step' + step).classList.add('active');
        document.querySelectorAll('.step')[step - 1].classList.add('active');
        currentStep = step;

        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function prevStep(step) {
        nextStep(step);
    }

    function validateStep(currentStepNum, nextStepNum) {
        let currentStepEl = document.getElementById(`step${currentStepNum}`);
        let inputs = currentStepEl.querySelectorAll('input, select, textarea');
        let isValid = true;
        inputs.forEach(input => {
            if (!input.checkValidity()) {
                isValid = false;
                input.reportValidity();
            }
        });
        
        if (isValid) {
            nextStep(nextStepNum);
        }
    }

    function initializeMap() {
        if (typeof L !== 'undefined' && !tripMap) {
            try {
                tripMap = L.map('map').setView([20.5937, 78.9629], 5)

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(tripMap)

                let destinationInput = document.getElementById('destination')
                if (destinationInput) {
                    destinationInput.addEventListener('change', updateMapLocation)
                }
                console.log('✅ Map initialized successfully!');
            } catch (error) {
                console.error('❌ Map initialization error:', error);
            }
        }
    }

    function updateDuration() {
        let start = document.getElementById('startDate')?.value;
        let end = document.getElementById('endDate')?.value;
        if (start && end) {
            let days = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24));
            document.getElementById('previewDuration').textContent = days > 0 ? `${days} ${days === 1 ? 'Day' : 'Days'}` : '-';
        }
    }

    // Live preview updates
    document.getElementById('title')?.addEventListener('input', (e) => {
        document.getElementById('previewTitle').textContent = e.target.value || '-';
    });

    document.getElementById('destination')?.addEventListener('input', (e) => {
        document.getElementById('previewDestination').textContent = e.target.value || '-';
    });

    document.getElementById('budget')?.addEventListener('input', (e) => {
        let value = e.target.value;
        document.getElementById('previewBudget').textContent = value ? `₹${parseInt(value).toLocaleString('en-IN')}` : '-';
    });

    document.getElementById('travelers')?.addEventListener('input', (e) => {
        document.getElementById('previewTravelers').textContent = e.target.value || '1';
    });

    document.getElementById('startDate')?.addEventListener('change', updateDuration);
    document.getElementById('endDate')?.addEventListener('change', updateDuration);
    
    // ✅ CRITICAL: Initialize map after page loads
    window.addEventListener('load', () => {
        setTimeout(initializeMap, 200);
    });
</script>
</body>
</html>
